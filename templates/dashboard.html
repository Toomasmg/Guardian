{% extends "base.html" %}

{% block title %}Dashboard Maestro - Guardian{% endblock %}

{% block extra_css %}
<style>
    /* --- ESTILOS GENERALES Y PC --- */
    .main-wrapper { background-color: var(--bg-panel); border-radius: 24px; padding: 2rem; box-shadow: var(--shadow-soft), 0 0 0 1px var(--border-soft); transition: 0.3s; }

    /* TARJETAS DE ESTADÍSTICAS CORREGIDAS */
    .stat-card { background-color: var(--bg-panel); border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow-card); border: 1px solid var(--border-soft); display: flex; align-items: center; gap: 1.5rem; height: 100%; transition: transform 0.2s, border-color 0.3s; }
    .stat-card:hover { transform: translateY(-3px); border-color: var(--accent-gold); }
    .card-link { text-decoration: none; color: inherit; }
    
    .stat-label { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;}
    .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
    .stat-subtitle { font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; }
    
    .icon-box { width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2); }
    .icon-green { background-color: var(--status-green-bg); color: var(--status-green); }
    .icon-brown { background-color: var(--status-brown-bg); color: var(--accent-gold-dark); }
    .icon-red { background-color: var(--status-red-bg); color: var(--status-red); }

    .accordion-item { border: none; background: transparent; }
    .accordion-button { background-color: var(--bg-panel); color: var(--text-main); font-weight: 800; border-radius: 16px !important; border: 1px solid var(--border-soft); box-shadow: var(--shadow-card); padding: 1.2rem; transition: 0.3s; }
    .accordion-button:not(.collapsed) { box-shadow: none; border-bottom-left-radius: 0 !important; border-bottom-right-radius: 0 !important; border-bottom: none;}
    .accordion-collapse { border: 1px solid var(--border-soft); border-top: none; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; background-color: var(--bg-panel); }
    .form-label { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.3rem; }

    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-soft); padding-bottom: 1rem; gap: 1rem; flex-wrap: wrap; }
    .section-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; color: var(--text-main); white-space: nowrap; }
    .btn-excel { background-color: var(--status-green-bg); color: var(--status-green); border: 1px solid var(--status-green); border-radius: 8px; font-size: 0.8rem; font-weight: 800; padding: 0.4rem 0.8rem; text-decoration: none; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-excel:hover { background-color: var(--status-green); color: white; }
    
    .search-wrapper { position: relative; width: 100%; max-width: 350px; }
    .search-wrapper input { background-color: var(--input-bg); border: 1px solid var(--border-soft); border-radius: 50px; padding: 0.5rem 1rem 0.5rem 2.8rem; font-size: 0.9rem; width: 100%; color: var(--text-main); transition: 0.3s; font-weight: 600;}
    .search-wrapper input:focus { background-color: var(--input-bg-focus); border-color: var(--accent-gold); outline: none; box-shadow: 0 0 0 3px rgba(199, 164, 122, 0.15); }
    .search-wrapper i.bi-search { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

    /* TABLA PC CORREGIDA Y ALINEADA */
    .table-custom { width: 100%; margin-bottom: 0; color: var(--text-main); border-collapse: collapse; }
    .table-custom th { font-size: 0.75rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 2px solid var(--border-soft); padding: 1rem; text-align: left; letter-spacing: 0.5px;}
    .table-custom td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid var(--border-soft); font-weight: 600; font-size: 0.95rem; text-align: left; }
    .table-custom tbody tr:hover td { background-color: rgba(199, 164, 122, 0.03); }
    .table-custom tbody tr:last-child td { border-bottom: none; }
    
    .badge-type { background-color: var(--status-brown-bg); color: var(--text-muted); border-radius: 6px; padding: 0.2rem 0.6rem; font-size: 0.7rem; font-weight: 800; letter-spacing: 0.5px; }
    .badge-status-active, .badge-status-expired, .badge-status-suspended { border-radius: 8px; padding: 0.35rem 0.8rem; font-size: 0.7rem; font-weight: 800; color: #fff; letter-spacing: 0.5px; display: inline-flex; align-items: center; gap: 4px; justify-content: center; min-width: 100px;}
    .badge-status-active { background-color: var(--status-green); box-shadow: 0 2px 5px rgba(108, 140, 108, 0.3);}
    .badge-status-expired { background-color: var(--status-red); box-shadow: 0 2px 5px rgba(168, 88, 88, 0.3);}
    .badge-status-suspended { background-color: var(--status-brown); box-shadow: 0 2px 5px rgba(93, 73, 59, 0.3);}

    .action-group { display: flex; gap: 6px; justify-content: flex-end; }
    .btn-action { width: 36px; height: 36px; border-radius: 10px; border: none; display: flex; align-items: center; justify-content: center; color: white; transition: 0.2s; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 0;}
    .btn-action:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-wa { background: linear-gradient(135deg, #25d366, #128c7e); }
    .btn-edit { background: linear-gradient(135deg, var(--status-brown), var(--accent-gold-dark)); }
    .btn-trash { background: linear-gradient(135deg, var(--status-red), #a02b2b); }
    
    .api-key-box { display: inline-flex; width: 100%; max-width: 220px; align-items: center; background: var(--input-bg); border: 1px solid var(--border-soft); border-radius: 8px; padding: 4px 8px; transition: 0.3s; }
    .api-key-box:focus-within { border-color: var(--accent-gold); box-shadow: 0 0 0 2px rgba(199, 164, 122, 0.1);}
    .api-key-box input { border: none; background: transparent; width: 100%; font-size: 0.8rem; color: var(--text-muted); outline: none; padding-left: 5px; font-family: monospace; font-weight: 700;}
    .api-key-box button { border: none; background: transparent; color: var(--text-muted); cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; justify-content: center;}
    .api-key-box button:hover { background-color: var(--border-soft); color: var(--text-main); }

    /* --- ESTILOS NATIVOS PARA MÓVIL --- */
    .mobile-lic-card { background-color: var(--bg-panel); border-radius: 20px; border: 1px solid var(--border-soft); box-shadow: var(--shadow-card); margin-bottom: 1.2rem; padding: 1.2rem; }
    .mobile-lic-card hr { margin: 1rem 0; border-color: var(--border-soft); opacity: 1; }
    .mobile-stat-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; margin-bottom: 0.6rem; }
    
    /* BOTONES MÓVIL CUADRADOS PERFECTOS */
    .mobile-actions { display: flex; justify-content: center; gap: 10px; margin-top: 1.5rem; }
    .mobile-actions form { margin: 0; }
    .mobile-actions .btn-action { 
        width: 48px !important; 
        height: 48px !important; 
        min-width: 48px !important;
        max-width: 48px !important;
        flex: 0 0 48px !important; /* Evita que se estiren como chicle */
        border-radius: 14px;
        font-size: 1.4rem;
        padding: 0;
    }

    /* Ajustes generales de pantalla chica */
    @media (max-width: 991px) {
        .main-wrapper { padding: 1.2rem; border-radius: 16px; }
        .section-header { flex-direction: column; align-items: stretch; gap: 1rem; }
        .search-wrapper { max-width: 100%; }
        
        /* Ajuste Tarjetas Superiores en Celu */
        .stat-card { padding: 1.2rem; flex-direction: column; gap: 12px; align-items: flex-start; }
        .icon-box { width: 45px; height: 45px; font-size: 1.4rem; }
        
        .app-header { flex-wrap: nowrap !important; padding-top: 1rem !important;}
        .user-pill-text { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-container">

    <header class="app-header d-flex justify-content-between align-items-center w-100 pt-4 pb-4">
        <a href="/" class="text-decoration-none flex-shrink-0">
            <img src="{{ url_for('static', filename='guardian.png') }}" alt="Guardian" style="height: 50px; object-fit: contain;">
        </a>
        
        <div class="d-flex align-items-center gap-3 flex-shrink-0">
            <button id="themeToggle" class="btn d-flex align-items-center justify-content-center p-0" style="width: 42px; height: 42px; border-radius: 50%; background-color: var(--bg-panel); border: 1px solid var(--border-soft); color: var(--accent-gold-dark); box-shadow: var(--shadow-card); transition: 0.3s;">
                <i class="bi bi-moon-fill fs-6" id="themeIcon"></i>
            </button>

            <div class="d-flex align-items-center gap-2 ps-1 pe-2 py-1" style="background-color: var(--bg-panel); border: 1px solid var(--border-soft); border-radius: 50px; box-shadow: var(--shadow-card);">
                <div style="width: 34px; height: 34px; border-radius: 50%; background-color: var(--accent-gold); display: flex; align-items: center; justify-content: center; color: white;"><i class="bi bi-person-fill"></i></div>
                <span class="user-pill-text" style="color: var(--text-main); font-weight: 800; font-size: 0.9rem; padding-left: 5px;">{{ current_user.username }}</span>
                <a href="/logout" class="btn btn-sm ms-2" style="background-color: var(--status-brown); color: #fff; border-radius: 50px; padding: 0.3rem 1rem; font-weight: 800; font-size: 0.8rem;">Salir</a>
            </div>
        </div>
    </header>

    <div class="main-wrapper">
        
        <div class="row g-3 mb-4">
            <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="icon-box icon-green shadow-sm"><i class="bi bi-cash-stack"></i></div>
                    <div>
                        <div class="stat-label">Ingresos Mes</div>
                        <div class="stat-value">${{ stats.revenue }}</div>
                        <div class="stat-subtitle" style="color: var(--status-green);"><i class="bi bi-graph-up-arrow me-1"></i>Estimado</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <a href="/?status=active" class="card-link">
                    <div class="stat-card">
                        <div class="icon-box icon-brown shadow-sm"><i class="bi bi-people-fill"></i></div>
                        <div>
                            <div class="stat-label">Activos / Total</div>
                            <div class="stat-value">{{ stats.active }}<span class="text-muted fs-5 ms-1">/{{ stats.total }}</span></div>
                            <div class="stat-subtitle text-muted"><i class="bi bi-check-circle-fill me-1" style="font-size: 0.75rem;"></i>Sistemas al día</div>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-12 col-md-4">
                <a href="/?status=expired" class="card-link">
                    <div class="stat-card" style="border-color: rgba(var(--status-red-rgb), 0.3);">
                        <div class="icon-box icon-red shadow-sm"><i class="bi bi-exclamation-diamond-fill"></i></div>
                        <div>
                            <div class="stat-label">Atención Requerida</div>
                            <div class="stat-value">{{ stats.expired }}</div>
                            <div class="stat-subtitle" style="color: var(--status-red);"><i class="bi bi-bell-fill me-1" style="font-size: 0.75rem;"></i>Vencidos/Bloq.</div>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert border alert-dismissible fade show shadow-sm mb-4" style="background-color: var(--bg-panel); border-color: var(--accent-gold) !important; color: var(--status-brown); border-radius: 16px;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-3 fs-4" style="color: var(--accent-gold);"></i>
                            <div style="font-weight: 700;">{{ message }}</div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" style="top: 50%; transform: translateY(-50%); right: 10px;"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="accordion mb-5" id="accordionForm" style="box-shadow: var(--shadow-card); border-radius: 20px;">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                        <div class="d-flex align-items-center gap-3">
                            <div style="width: 36px; height: 36px; background: var(--accent-gold-dark); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;"><i class="bi bi-plus-lg"></i></div>
                            <span style="font-size: 1.05rem;">Generar Nueva Licencia</span>
                        </div>
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionForm">
                    <div class="accordion-body p-4">
                        <form action="/create_license" method="POST">
                            <div class="row g-3">
                                <div class="col-12 col-md-6 col-lg-3">
                                    <label class="form-label">Negocio</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-shop"></i></span>
                                        <input type="text" name="business_name" class="form-control border-start-0 ps-0" placeholder="Ej: Taller El Rayo" required>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6 col-lg-2">
                                     <label class="form-label d-flex justify-content-between align-items-center">
                                        Rubro <a href="#" data-bs-toggle="modal" data-bs-target="#modalCategory" class="text-decoration-none" style="color: var(--accent-gold);"><i class="bi bi-plus-circle-fill"></i></a>
                                    </label>
                                    <select name="app_type" class="form-select">
                                        {% for cat in categories %}
                                            <option value="{{ cat.name }}">{{ cat.name }}</option>
                                        {% else %}
                                            <option value="General">General</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-6 col-md-6 col-lg-3">
                                    <label class="form-label">Dueño</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-person"></i></span>
                                        <input type="text" name="owner_name" class="form-control border-start-0 ps-0" required>
                                    </div>
                                </div>
                                <div class="col-6 col-md-6 col-lg-2">
                                    <label class="form-label">DNI / CUIT</label>
                                    <input type="text" name="owner_dni" class="form-control" placeholder="Opcional">
                                </div>
                                <div class="col-6 col-md-6 col-lg-2">
                                    <label class="form-label">WhatsApp</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-whatsapp"></i></span>
                                        <input type="text" name="phone" class="form-control border-start-0 ps-0" placeholder="549..." required>
                                    </div>
                                </div>
                                
                                <div class="col-12 col-md-6 col-lg-4">
                                    <label class="form-label">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-envelope"></i></span>
                                        <input type="email" name="email" class="form-control border-start-0 ps-0" placeholder="Para notificaciones">
                                    </div>
                                </div>
                                <div class="col-6 col-md-3 col-lg-2">
                                    <label class="form-label" style="color: var(--accent-gold-dark);">Precio $</label>
                                    <input type="number" name="price" class="form-control fw-bold" value="10000" step="0.01" min="0" style="color: var(--accent-gold-dark);">
                                </div>
                                <div class="col-6 col-md-3 col-lg-2">
                                    <label class="form-label">Días Iniciales</label>
                                    <input type="number" name="days" class="form-control text-center" value="30">
                                </div>
                                <div class="col-12 col-lg-4 d-flex align-items-end">
                                    <button type="submit" class="btn-gradient-gold w-100 py-2 d-flex justify-content-center align-items-center gap-2" style="height: 48px; border-radius: 12px;">
                                        <i class="bi bi-rocket-takeoff-fill fs-5"></i> Crear y Autorizar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-header">
            <div class="section-title">
                <i class="bi bi-grid-fill text-muted me-2"></i>Cartera de Clientes
            </div>
            
            <div class="d-flex gap-3 w-100 justify-content-end align-items-center flex-wrap">
                 <a href="/export_data" class="btn-excel"><i class="bi bi-file-earmark-excel-fill fs-6"></i> Excel</a>
                <form action="/" method="GET" class="search-wrapper flex-grow-1 flex-lg-grow-0">
                    <i class="bi bi-search"></i>
                    <input type="text" name="q" placeholder="Buscar negocio, DNI o API Key..." value="{{ search_query or '' }}">
                    {% if status_filter or search_query %}
                        <a href="/" class="position-absolute text-muted" style="right: 15px; top: 50%; transform: translateY(-50%); text-decoration: none;"><i class="bi bi-x-circle-fill"></i></a>
                    {% endif %}
                </form>
            </div>
        </div>

        <div class="d-none d-lg-block table-responsive pb-4">
            <table class="table-custom">
                <thead>
                    <tr>
                        <th style="width: 18%;">NEGOCIO</th>
                        <th style="width: 18%;">CONTACTO / DNI</th>
                        <th style="width: 22%;">API KEY (SISTEMA)</th>
                        <th class="text-center" style="width: 12%;">PRECIO</th>
                        <th class="text-center" style="width: 12%;">ESTADO</th>
                        <th class="text-end" style="width: 18%;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lic in licenses %}
                    {% set days_left = (lic.expiration_date - now).days %}
                    {% set wa_msg = "Hola " + lic.owner_name + ", te contactamos por tu sistema." %}
                    {% if not lic.is_active %}{% set wa_msg = "Hola " + lic.owner_name + ", tu sistema está SUSPENDIDO. Por favor regularizar pago." %}
                    {% elif days_left < 0 %}{% set wa_msg = "Hola " + lic.owner_name + ", tu licencia venció hace " + (days_left * -1)|string + " días. Debes renovar." %}
                    {% elif days_left < 5 %}{% set wa_msg = "Hola " + lic.owner_name + ", recordatorio: tu licencia vence en " + days_left|string + " días." %}{% endif %}

                    <tr>
                        <td>
                            <div style="font-weight: 800; color: var(--text-main); font-size: 1.05rem; line-height: 1.2;">{{ lic.business_name }}</div>
                            <div class="badge-type mt-2 d-inline-block">{{ lic.app_type }}</div>
                        </td>
                        
                        <td>
                            <div style="font-weight: 800; color: var(--text-main); font-size: 1rem; line-height: 1.2;">{{ lic.owner_name }}</div>
                            <div class="text-muted fw-bold mt-1" style="font-size: 0.8rem;">
                                {% if lic.owner_dni %}DNI: {{ lic.owner_dni }}{% else %}--{% endif %}
                            </div>
                        </td>
                        
                        <td>
                            <div class="api-key-box mb-2">
                                <input type="text" value="{{ lic.api_key }}" id="key-{{ loop.index }}" readonly>
                                <button type="button" onclick="copyToClipboard('key-{{ loop.index }}')" title="Copiar"><i class="bi bi-files"></i></button>
                            </div>
                            <div>
                                {% if lic.hardware_id %}
                                    <span class="text-muted fw-bold d-inline-flex align-items-center" style="font-size: 0.75rem; color: var(--status-green) !important;">
                                        <i class="bi bi-pc-display me-1"></i>Vinculado
                                    </span>
                                {% else %}
                                    <span class="text-muted fw-bold d-inline-flex align-items-center" style="font-size: 0.75rem;">
                                        <i class="bi bi-pc me-1"></i>Pendiente
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        
                        <td class="text-center">
                            <span style="color: var(--accent-gold-dark); font-weight: 800; font-size: 1.15rem;">${{ lic.price or 0 }}</span>
                        </td>
                        
                        <td class="text-center">
                            {% if not lic.is_active %}<span class="badge-status-suspended"><i class="bi bi-pause-fill me-1"></i>SUSPENDIDO</span>
                            {% elif days_left < 0 %}<span class="badge-status-expired"><i class="bi bi-x-circle-fill me-1"></i>VENCIDO</span>
                            {% else %}<span class="badge-status-active"><i class="bi bi-check-circle-fill me-1"></i>ACTIVO</span>{% endif %}
                            
                            <div class="mt-2" style="color: {{ 'var(--status-red)' if days_left < 0 else 'var(--text-main)' }}; font-weight: 800; font-size: 0.9rem;">
                                {{ lic.expiration_date.strftime('%d/%m/%y') }}
                            </div>
                            <div class="text-muted fw-bold" style="color: {{ 'var(--status-red)' if days_left < 5 and days_left >= 0 else 'var(--text-muted)' }} !important; font-size: 0.75rem;">
                                {% if days_left < 0 %}Hace {{ days_left * -1 }} días{% elif days_left == 0 %}¡Vence Hoy!{% else %}En {{ days_left }} días{% endif %}
                            </div>
                        </td>
                        
                        <td class="text-end">
                            <div class="action-group">
                                {% if lic.phone %}
                                    <a href="https://wa.me/{{ lic.phone }}?text={{ wa_msg }}" target="_blank" class="btn-action btn-wa" title="WhatsApp"><i class="bi bi-whatsapp"></i></a>
                                {% endif %}
                                <form action="/reset_hwid/{{ lic.id }}" method="POST" class="d-inline" onsubmit="return confirm('¿Desvincular la PC de este cliente?');">
                                    <button class="btn-action btn-edit" title="Desvincular PC"><i class="bi bi-hdd-network"></i></button>
                                </form>
                                <button type="button" class="btn-action btn-edit" data-bs-toggle="modal" data-bs-target="#modalDays{{ lic.id }}" title="Gestionar Días"><i class="bi bi-calendar-range-fill"></i></button>
                                <form action="/toggle/{{ lic.id }}" method="POST" class="d-inline">
                                    <button class="btn-action btn-edit" style="background: {{ 'linear-gradient(135deg, var(--status-red), #a02b2b)' if not lic.is_active else 'linear-gradient(135deg, var(--status-brown), var(--accent-gold-dark))' }}" title="{{ 'Reactivar' if not lic.is_active else 'Suspender' }}">
                                        <i class="bi {{ 'bi-play-fill text-white' if not lic.is_active else 'bi-pause-fill' }}"></i>
                                    </button>
                                </form>
                                <form action="/delete/{{ lic.id }}" method="POST" class="d-inline" onsubmit="return confirm('¿ELIMINAR CLIENTE DEFINITIVAMENTE?');">
                                    <button class="btn-action btn-trash" title="Eliminar Cliente"><i class="bi bi-trash-fill"></i></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center py-5 text-muted"><i class="bi bi-inbox-fill fs-1 mb-3 d-block" style="opacity: 0.3;"></i>Sin clientes registrados</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-block d-lg-none">
            {% for lic in licenses %}
            {% set days_left = (lic.expiration_date - now).days %}
            {% set wa_msg = "Hola " + lic.owner_name + ", te contactamos por tu sistema." %}
            {% if not lic.is_active %}{% set wa_msg = "Hola " + lic.owner_name + ", tu sistema está SUSPENDIDO. Por favor regularizar pago." %}
            {% elif days_left < 0 %}{% set wa_msg = "Hola " + lic.owner_name + ", tu licencia venció hace " + (days_left * -1)|string + " días. Debes renovar." %}
            {% elif days_left < 5 %}{% set wa_msg = "Hola " + lic.owner_name + ", recordatorio: tu licencia vence en " + days_left|string + " días." %}{% endif %}
            
            <div class="mobile-lic-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h5 class="fw-bold mb-1" style="color: var(--text-main); font-size: 1.25rem;">{{ lic.business_name }}</h5>
                        <span class="badge-type">{{ lic.app_type }}</span>
                    </div>
                    <div>
                        {% if not lic.is_active %}<span class="badge-status-suspended">SUSPENDIDO</span>
                        {% elif days_left < 0 %}<span class="badge-status-expired">VENCIDO</span>
                        {% else %}<span class="badge-status-active">ACTIVO</span>{% endif %}
                    </div>
                </div>

                <hr>

                <div class="mobile-stat-row text-muted fw-bold">
                    <span style="font-size: 1rem;"><i class="bi bi-person-fill me-2"></i>{{ lic.owner_name }}</span>
                    <span style="color: var(--accent-gold-dark); font-size: 1.2rem; font-weight: 800;">${{ lic.price or 0 }}</span>
                </div>
                
                <div class="mobile-stat-row text-muted fw-bold">
                    <span>
                        <i class="bi bi-calendar-event-fill me-2"></i>Vence: 
                        <strong style="color: {{ 'var(--status-red)' if days_left < 0 else 'var(--text-main)' }};">{{ lic.expiration_date.strftime('%d/%m/%y') }}</strong>
                    </span>
                    <span>
                        {% if lic.hardware_id %}
                            <i class="bi bi-pc-display me-1" style="color: var(--status-green);"></i>Vinculado
                        {% else %}
                            <i class="bi bi-pc me-1"></i>Pendiente
                        {% endif %}
                    </span>
                </div>

                <div class="api-key-box mt-3 mb-2" style="max-width: 100%;">
                    <input type="text" value="{{ lic.api_key }}" id="m-key-{{ loop.index }}" readonly>
                    <button type="button" onclick="copyToClipboard('m-key-{{ loop.index }}')" style="padding: 6px;"><i class="bi bi-files fs-6"></i></button>
                </div>

                <div class="mobile-actions">
                    {% if lic.phone %}
                        <a href="https://wa.me/{{ lic.phone }}?text={{ wa_msg }}" target="_blank" class="btn-action btn-wa"><i class="bi bi-whatsapp"></i></a>
                    {% endif %}
                    <form action="/reset_hwid/{{ lic.id }}" method="POST" onsubmit="return confirm('¿Desvincular la PC?');">
                        <button class="btn-action btn-edit"><i class="bi bi-hdd-network"></i></button>
                    </form>
                    <button type="button" class="btn-action btn-edit" data-bs-toggle="modal" data-bs-target="#modalDays{{ lic.id }}"><i class="bi bi-calendar-range-fill"></i></button>
                    <form action="/toggle/{{ lic.id }}" method="POST">
                        <button class="btn-action btn-edit" style="background: {{ 'linear-gradient(135deg, var(--status-red), #a02b2b)' if not lic.is_active else 'linear-gradient(135deg, var(--status-brown), var(--accent-gold-dark))' }}">
                            <i class="bi {{ 'bi-play-fill text-white' if not lic.is_active else 'bi-pause-fill' }}"></i>
                        </button>
                    </form>
                    <form action="/delete/{{ lic.id }}" method="POST" onsubmit="return confirm('¿ELIMINAR CLIENTE?');">
                        <button class="btn-action btn-trash"><i class="bi bi-trash-fill"></i></button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted"><i class="bi bi-inbox-fill fs-1 mb-3 d-block" style="opacity: 0.3;"></i>Sin clientes registrados</div>
            {% endfor %}
        </div>

        {% for lic in licenses %}
        <div class="modal fade" id="modalDays{{ lic.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 24px; border: 1px solid var(--border-soft); box-shadow: var(--shadow-card);">
                    <div class="modal-header border-0 pb-2 pt-4 px-4">
                        <div>
                            <h6 class="modal-title fw-bold mb-1" style="color: var(--text-main); font-size: 1.2rem;">{{ lic.business_name }}</h6>
                            <span class="text-muted" style="font-size: 0.85rem;">Gestión de Vencimiento</span>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" style="background-color: var(--bg-main); opacity: 1;"></button>
                    </div>
                    <div class="modal-body px-4 pb-4 pt-2">
                        <form action="/renew/{{ lic.id }}" method="POST" class="mb-4 p-3" style="background-color: rgba(var(--status-green-rgb), 0.1); border-radius: 16px; border: 1px solid var(--status-green);">
                            <label class="form-label fw-bold mb-3" style="color: var(--status-green); font-size: 0.8rem;"><i class="bi bi-lightning-charge-fill me-1"></i>Renovación Rápida</label>
                            <button class="btn w-100 py-3 fw-bold d-flex align-items-center justify-content-center gap-2" type="submit" style="background-color: var(--status-green); color: white; border-radius: 12px; transition: 0.2s; border: none; box-shadow: 0 4px 12px rgba(var(--status-green-rgb), 0.3);">
                                <i class="bi bi-calendar-plus-fill fs-5"></i> Sumar 1 Mes (+30 días)
                            </button>
                        </form>

                        <form action="/modify_days/{{ lic.id }}" method="POST" class="p-3" style="background-color: var(--input-bg); border-radius: 16px; border: 1px solid var(--border-soft);">
                            <label class="form-label mb-3" style="color: var(--text-main);"><i class="bi bi-sliders me-1"></i>Ajuste Manual</label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary border-end-0 fw-bold fs-5" type="button" onclick="this.nextElementSibling.stepDown()" style="border-color: var(--border-soft); color: var(--text-muted);">-</button>
                                <input type="number" name="days" class="form-control text-center fw-bold fs-5" placeholder="0" required value="0" style="border-color: var(--border-soft); background-color: var(--bg-panel); color: var(--text-main);">
                                <button class="btn btn-outline-secondary border-start-0 fw-bold fs-5" type="button" onclick="this.previousElementSibling.stepUp()" style="border-color: var(--border-soft); color: var(--text-muted);">+</button>
                                <button class="btn ms-2 fw-bold px-4" style="background: var(--accent-gold-dark); color: white; border-radius: 12px; border: none;" type="submit">Aplicar</button>
                            </div>
                            <small class="text-muted mt-2 d-block fst-italic" style="font-size: 0.75rem;">*Usá números negativos (ej: -5) para restar días.</small>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>
</div> 

<div class="modal fade" id="modalCategory" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content" style="border-radius: 24px; border: 1px solid var(--border-soft); box-shadow: var(--shadow-card);">
            <div class="modal-header border-0 pb-0 pt-3 px-3">
                <h6 class="modal-title fw-bold" style="color: var(--text-main);">Nuevo Rubro</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form action="/add_category" method="POST">
                    <div class="mb-3 bg-input rounded-3 p-1 border border-soft">
                        <input type="text" name="category_name" class="form-control border-0 bg-transparent shadow-none fw-bold" placeholder="Ej: Farmacia" required autofocus style="color: var(--text-main);">
                    </div>
                    <button type="submit" class="btn-gradient-gold w-100 py-2 rounded-3 fw-bold">Guardar Rubro</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(elementId) {
        var copyText = document.getElementById(elementId);
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
             navigator.clipboard.writeText(copyText.value).then(onCopySuccess, onCopyError);
        } else {
            try { document.execCommand('copy'); onCopySuccess(); } 
            catch (err) { onCopyError(err); }
        }

        function onCopySuccess() {
            var btn = copyText.nextElementSibling;
            var originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-lg fw-bold" style="color: var(--status-green);"></i>';
            setTimeout(function() { btn.innerHTML = originalIcon; }, 2000);
        }
        function onCopyError(err) { console.error('Error al copiar: ', err); }
    }
</script>
{% endblock %}